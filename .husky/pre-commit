#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Run linter
echo "ðŸ” Running ESLint..."
npm run lint || {
  echo "âŒ ESLint failed. Please fix the errors before committing."
  exit 1
}

# Run type check
echo "ðŸ” Running TypeScript check..."
npx tsc --noEmit || {
  echo "âŒ TypeScript check failed. Please fix the type errors."
  exit 1
}

# Run tests
echo "ðŸ§ª Running tests..."
npm test -- --run --reporter=verbose || {
  echo "âŒ Tests failed. Please fix the failing tests."
  exit 1
}

# Check test coverage
echo "ðŸ“Š Checking test coverage..."
npm test -- --run --coverage --reporter=json > coverage-tmp.json 2>&1

COVERAGE=$(cat coverage/coverage-summary.json | grep -o '"pct":[0-9.]*' | head -1 | grep -o '[0-9.]*')

if [ -n "$COVERAGE" ]; then
  echo "Current coverage: $COVERAGE%"
  
  # Minimum coverage threshold
  THRESHOLD=50
  
  if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
    echo "âš ï¸  Warning: Coverage is below $THRESHOLD%. Current: $COVERAGE%"
    echo "Consider adding more tests before committing."
  else
    echo "âœ… Coverage check passed: $COVERAGE%"
  fi
else
  echo "âš ï¸  Could not determine coverage"
fi

rm -f coverage-tmp.json

echo "âœ… All pre-commit checks passed!"
echo "ðŸ“¦ Preparing commit..."
